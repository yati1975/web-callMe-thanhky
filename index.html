<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="version" content="1.0.10">
<script src="./js/qrcode.min.js"></script>
<script src="./js/crypto-js.min.js"></script>
<script src="./js/localforage.min.js"></script>
<script src="./WebSocket_lower.js"></script>  
<!-- print-ticket å¢åŠ  -->
 <script src="./js/print-config.js"></script>
<script src="./js/print-ticket.js"></script>


<title>èª è¨˜æŠ½ç¥¨æ©Ÿ</title>
<link rel="icon" type="image/png" sizes="32x32" href="./images/web32x32.png"> 
<style>
  :root{
    --orange: #f58600; /* å¯èª¿æ•´æ©˜è‰² */
    --circle-size: clamp(84px, 10vw, 18vh);/*84px*/ /* åœ“ç›´å¾‘ï¼Œå¯æ”¹ */
    --overlap: clamp( -4.5vh,-2.5vw ,-22px); /*-22px;*/ /* é‡ç–Šé‡ï¼ˆè² å€¼ï¼‰ */
  }

  body{
    font-family: "Noto Sans TC", "Helvetica Neue", Arial;
    background: #fff;
    /* padding: 48px; */
    overflow: hidden;
  }
  .dropdown {
      display: flex;
      flex-direction: column;
  }
  .dropdown-button-area{
      display: flex;
      flex-direction: row;
      align-items: center;
      flex-wrap: nowrap;
      justify-content: center;
      /* align-content: center; */
      right: 1vw;
      position: absolute;
      top: 1vh;
  }
  button.dropdown-button {
      width: 40px;
      height: 40px;
      padding: 0;
      border: none;
      background: transparent;
      cursor: pointer;
      flex-direction: row;
      /* align-content: center; */
      justify-content: center;
      /* align-items: center; */
      z-index: 1000;        
  }
  button.dropdown-button img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: opacity 0.3s ease;            
  }
  button.dropdown-button p{
      color: white;
      font-size: 1em;
      padding-left: 2px;
      text-align: center; /* ç½®ä¸­æ¨™é¡Œ */
  }        
  button.dropdown-button:hover img {
      opacity: 0.7; /* hover æ•ˆæœï¼Œè®Šé€æ˜ä¸€é» */
  }
  .dropdown-content {
      display: none;
      position: absolute;
      background-color: #043190;/*#14c4b7;*/
      box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
      min-width: 130px;
      z-index: 999;
      top: 60px;
      right: 0;
      color: white;
  }
  .dropdown-content p{
      display: block;
      text-align: center;
  }
  .dropdown-content-form{
      padding: 5px 5px;
      cursor: pointer;
      text-align: center;
  }
  .show {
      display: block;
  }


  .language-option {
      display: flex;
      align-items: center;
      cursor: pointer;
      margin: 6px 0;
  }

  .language-option input[type="radio"] {
      display: none; /* éš±è—åŸå§‹ radio */
  }
  .custom-radio {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 2px solid #ccc;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
      font-size: 16px;
      color: #F68200;
      visibility: hidden; /* é è¨­éš±è—ï¼Œåªæœ‰é¸ä¸­çš„æ‰é¡¯ç¤º */
  }

  .language-option input[type="radio"]:checked + .custom-radio {
      visibility: visible;
  }

  .language-option input[type="radio"]:checked + .custom-radio::before {
      content: 'âœ”'; /* æ‰“å‹¾å‹¾ç¬¦è™Ÿ */
  }
  .storelogo{
    width: 80%; 
    height: auto;
  }
  .storelogo img{
    width: 100%;
    height: auto;
  }

  .badge {
    position: relative;
    display: inline-flex;
    align-items: center;
    height: var(--circle-size);
    /* ç”¨ padding è®“æ–‡å­—å·¦å³ä¿ç•™ç©ºé–“ */
    padding: 0 18px;
    /* è‹¥å¸Œæœ›æ•´é«”ç½®ä¸­ï¼Œå¯ç”¨ margin: 0 auto; */
  }

  .circles {
    display: flex;
    align-items: center;
    /* è®“åœ“åœˆåœ¨æ–‡å­—å¾Œæ–¹ */
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%); /* å‚ç›´ & æ°´å¹³ç½®ä¸­ */
    pointer-events: none; /* ä¸æœƒæ””æˆªé»æ“Š */
    align-items: center;

  }

  .circle {
    width: var(--circle-size);
    height: var(--circle-size);
    border-radius: 50%;
    background: linear-gradient(180deg, var(--orange) 0%, #ef7f00 100%);
    box-shadow: 0 0 0 2px rgba(0,0,0,0.02) inset;
    flex: 0 0 auto;
    margin-left: var(--overlap);
  }

  /* ç¬¬ä¸€å€‹åœ“ä¸è¦æœ‰è²  marginï¼ˆè¦–è¦ºä¸Šå¾å·¦é‚Šé–‹å§‹ï¼‰ */
  .circle:first-child{
    margin-left: 0;
  }

  /* æ–‡å­—åœ¨æœ€ä¸Šå±¤ */
  .badge .text {
    position: relative;
    z-index: 2;
    color: white;
    font-size: clamp(28px,3vw, 2.8rem);
    letter-spacing: 2px;
    white-space: nowrap;
    padding: 0 8px;
  }


.arrow-label {
  display: inline-block;
  background-color: #003399; /* è—è‰²èƒŒæ™¯ */
  color: white;
  font-size: 20px;
  font-family: "Microsoft JhengHei", sans-serif;
  padding: 20px 20px;
  line-height: 1.4;
  /* position: absolute;
  bottom: 0; */
  width: 90%;
  text-align: center;
  cursor: pointer;
  border-radius: 4px 0 0 4px; /* å·¦å´åœ“è§’ */
  clip-path: polygon(
    0 0,                  /* å·¦ä¸Šè§’ */
    calc(100% - 20px) 0,  /* å³ä¸Šè§’ç®­é ­èµ·é» */
    100% 50%,             /* ç®­é ­å°–ç«¯ */
    calc(100% - 20px) 100%, /* å³ä¸‹è§’ç®­é ­èµ·é» */
    0 100%                /* å·¦ä¸‹è§’ */
  );
}
.arrow-label.disabled {
    cursor: not-allowed;
    pointer-events: none;
}
.currentDisp{
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;    
}
.currentDisp p{
  color: #043190;
  font-size: 1.2rem;
  margin: 0;
}
#currentCall {
    background-color: black;
    color: red;
    padding: 1vh 1vw; 
    border-radius: 6px;
    font-family: "Noto Sans TC","Microsoft JhengHei","PingFang TC",sans-serif;
    /*/font-variant-east-asian: full-width;*/
    font-weight: bold;
    font-size: clamp(30px, 4vw, 4rem);
    text-align: center;
    justify-content: center;
    display: flex;
    align-items: center;
    /* margin: 0 8px 0 8px; */
    width: 10vw;
    height: auto;
    margin-top: 2vh;
    letter-spacing: 3px;
} 
.page1{
    display: flex;
    width: 80%;
    min-width: 300px;
    max-width: 600px;
    height: 60vh;
    /* box-sizing: border-box; */
    padding: 24px;
    /* display: grid; */
    grid-template-rows: 1fr auto;
    gap: 12px;
    overflow: hidden;
}
.qrcode-container {
    width: 100%;
    height: auto;
    border-radius: 20px;
    background-color: #043190;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;    
    margin: 10px auto;
    /* box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    margin: 1vh auto; */
} 

.qrcode-title {
  color: white;
  font-size: 2rem;
  margin: auto;
}
.qrcode-title2 {
  color: white;
  font-size: 1.2rem;
  margin: auto;
}
.qrcode-bg{
  max-width: 260px;
  max-height: 260px;
  border-radius: 20px;
  border: 10px solid white;
  margin: 8px auto;
}
#about-qrcode {
  display: flex;
  /*width: 100%;*/
  /*height: auto;*/
  max-width: 200px;
  max-height: 200px;
  border-radius: 5px;
  border: 1px solid white;
  box-sizing: border-box; 
  pointer-events: none; /* ç¦æ­¢é»æ“Š */
  cursor: default;      /* æ¸¸æ¨™ä¸æœƒè®Šæˆæ‰‹æŒ‡ */
}
button.confirm-button {
  background-color: #FD5126;
  border: none;
  border-radius: 10px;
  transition: background-color 0.3s ease, transform 0.2s;
  cursor: pointer;
  /*height: auto;*/
  /*margin-left: auto;*/
  color: white;
  font-size: 2.5rem;
  /* padding: 20px 20px; */
  line-height: 1.4;
  width:160px;
  height: 160px;
  margin: 0px 10px 8vh;
}

button.confirm-button:hover {
    background-color: #FD5126;
    transform: scale(1.05);
}

button.confirm-button:active {
    transform: scale(0.98);
}
button.confirm-button.disabled {
    background-color: transparent;
    border: 2px solid #a1a1a1;
    color: #a1a1a1;
    cursor: not-allowed;
    pointer-events: none;
}
/* button.home-button {
    width: 40px;
    height: 40px;
    padding: 0;
    border: none;
    background: transparent;
    cursor: pointer;
    flex-direction: row;

    justify-content: center;
    z-index: 1;        
}
button.home-button img{
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: opacity 0.3s ease;            
}
button.home-button:hover img {
    opacity: 0.7; 
} */


.page2{
  display: flex;
  width: 100%;
  min-width: 300px;
  height: auto;
  padding: 10px 24px;
  grid-template-rows: 1fr auto;
  /* gap: 12px; */
  overflow: hidden;
  flex-direction: column;
  align-items: center;
  justify-content: space-evenly;
}
.group-container {
  /* display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 15px;
  margin-top: 20px; */
  display: grid;
  grid-template-columns: repeat(2, 1fr); /* å›ºå®šäºŒæ¬„ */
  gap: clamp(2vh, 15px, 2vw);
  margin-top: 20px;  
}

.group-card {
  background-color: #043190; /* æ·±è—èƒŒæ™¯ */
  color: white;
  border-radius: 15px;
  /* padding: 15px 20px; */
  padding: 15px 10px;
  min-width: 150px;
  width: 28vw;
  height: 24vh;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.group-title {
    font-size: 4.5rem;
    margin-bottom: 10px;
    display: flex;
    justify-content: center;
    height: 65%;
    border-bottom: 1px solid #c8c8c8;
}

.group-info {
    font-size: 1.8rem;
    display: flex;
    align-items: center;
    justify-content: center;  
    color: #75a0f9;
}

.icon {
  margin-right: 8px;
}
.icon img{
  width: auto;
  height: 50px;
}

.count {
  color: #F68200;
  font-weight: bold;
  margin: 0 8px 0 8px;
}

/* é¸å–ç‹€æ…‹çš„æ¨£å¼ */
.group-card.selected {
  background-color: #F68200;
}

.group-card.selected .group-info {
  color: #FFE9A1;
}

.group-card.selected .count {
  color: #E4FF98;
}

.group-card.selected .icon img {
  content: url("./images/waiting_light.png");
}

.refresh {
  margin: 15px 0 0 0;
  font-size: 1.5rem;
  color: #043190;
}

/* èƒŒæ™¯é®ç½© */
.overlay2 {
    display: none; /* åˆå§‹éš±è— */
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0, 0, 0, 0.5); 
    z-index: 999;
    justify-content: center;
    align-items: center;
}

/* æµ®å‹•è¦–çª—æ¨£å¼ */
.modal {
    position: relative;
    background-color: #ffffff;
    padding: 20px;
    width: 100%;
    max-width: 300px;
    overflow: hidden;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    text-align: center;
    /* color: white; */
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    height: auto;
    min-height: 280px;
}
.modal-button {
    /* background-color: #006d65; */
    border: none;
    /* padding: 20px 10px;  */
    border-radius: 10px;
    cursor: pointer;
    width: 100%;
    max-width: 300px;        
    /* height: auto; */
    color: #00534D;
}    

.modal-box {
    display: grid;
    position: relative;
    width: 100%;
    max-width: 300px;
    padding: 10px;
    border-bottom: 1px solid #eee;
    box-sizing: border-box;
    /* color: white; */
    color: #043190;
    height: auto;
    /* min-height: 140px; */
    align-content: space-around;
}
.modal-box:last-child {
    border-bottom: none;
}
.pStore{
    font-size: 2rem;
    color: #043190;
}
.pSection{
    font-size: 2rem;
    color: #F68200;
}
.pNumber{
    font-size: 5rem;
    color: #F68200;
}
.pTime{
    font-size: 1rem;
    color: #043190;
}
.modal-box-info {
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    justify-content: center;  
}

.modal-box-icon {
  margin-right: 4px;
}
.modal-box-icon img{
  width: auto;
  height: 30px;
}

.modal-box-count {
  color: orange;
  font-weight: bold;
  margin: 5px;
}
.hidden{
  display: none;
}
.footer {
    /* margin-left: -56px; */
    /* max-width: 600px; */
    display: flex;
    position: relative;
    bottom: env(safe-area-inset-bottom, 10px);
    flex-direction: column;
    align-items: center;
    flex-wrap: nowrap;
    width: 100vw;
}
#ver{
    font-size: 0.8rem;
}
.resp { display:flex; gap:12px; padding:12px;  }
/* .resp > * { padding:10px; background:#fff; border:1px solid #ddd; } */
.resp > * { /*padding:10px;*/ background:#fff;}
.resp .left, .resp .right { flex: 0 0 16vw; }
.resp .center { 
  flex:1; 
  min-width:0; 
  display: flex;
  flex-direction: column;
  align-items: center;
  
}
.resp .left {
    display: flex;
    flex-direction: column;
    /* align-content: center; */
    align-items: center;
}
.resp .right {
    /*display: flex;*/
    /*align-items: flex-end;*/
    /* flex-direction: column-reverse; */
    /*justify-content: space-between;*/

    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    align-items: center;
}


/* éŸ¿æ‡‰å¼ç¸®å°å­—é«” */
@media (max-width: 480px){
  :root{ --circle-size: 64px; --overlap: -18px; }
  .badge .text{ font-size: 18px; letter-spacing: 1px; }
  #currentCall {
    font-size: 1.5rem;
  }  
  .group-title{
    font-size: 1.5rem;
  }
  .group-info {
    font-size: 0.8rem;
  }
  .icon img{
    height: 25px;
  }  
}
/* å°è¢å¹•æ”¹æˆç›´åˆ— */
@media (max-width: 720px) {
  body{
    overflow:auto;
  }
  .group-container {
    grid-template-columns: 1fr; /* ä¸€åˆ—ä¸€æ¬„ */
  }
  .page1{
    height: auto;
  }
  .page2{
    height: auto;
  }
  .group-card {
    width: auto;
    height: auto;
  }
  .group-title{
    font-size: 2rem;
  }
  .group-info {
    font-size: 1rem;
  }
  .icon img{
    height: 30px;
  }
  #currentCall {
    padding: 1vw 1vh;
    font-size: clamp(30px, 4vh, 4rem);
    padding: 1vh 1vw; 
    width: 60vw;
    margin-top: 0;
  }
  button.confirm-button {
    width: 100%;
    height: auto;
  }
  .storelogo{
    height: auto;
    width: 40%;
  }
  .resp { flex-direction: column; }
  .resp .left, .resp .right { width: 100%; flex: none; }
} 
</style>
</head>
<body>
  <!-- é é¦– -->
  <div class="dropdown hidden">
      <div class = "dropdown-button-area">
      <button class ="dropdown-button" id="earth">
          <img src="images/earthB.png" >
      </button>
      <p id="langstr" style="color:#043190;">EN</p>
      </div>
      <div class="dropdown-content" id="dropdownMenu">
          <div class="dropdown-content-form"><spin id="str00">é¸æ“‡èªè¨€ </spin>
              <form id="languageSelector">
                  <label class="language-option">
                      <input type="radio" name="language" value="EN" onclick="selectOption(this)">
                      <span class="custom-radio"></span>
                      English
                  </label>
                  <label class="language-option">
                      <input type="radio" name="language" value="TW" onclick="selectOption(this)">
                      <span class="custom-radio"></span>
                      ä¸­æ–‡
                  </label>
                  <label class="language-option">
                      <input type="radio" name="language" value="JP" onclick="selectOption(this)">
                      <span class="custom-radio"></span>
                      æ—¥æœ¬èª
                  </label>
                  <label class="language-option">
                      <input type="radio" name="language" value="KR" onclick="selectOption(this)">
                      <span class="custom-radio"></span>
                      í•œêµ­ì¸
                  </label>                    
              </form>
          </div>
      </div>
  </div>         


<div class="resp">
  <div class="left">
    <div class="storelogo">
      <img src="./images/106674939.png" style="" >
    </div>
    
    <div class="currentDisp">
      <div id="currentCall">000</div>
      <p>ç›®å‰å«è™Ÿ</p> 
    </div>
  </div>
  <div class="center">
    <div class="badge" aria-hidden="false">
      <div class="circles" aria-hidden="true">
        <!-- æ ¹æ“šæ–‡å­—é•·åº¦èª¿æ•´è¦æ”¾å¤šå°‘å€‹ circle -->
        <div class="circle"></div>
        <div class="circle"></div>
        <div class="circle"></div>
        <div class="circle"></div>
        <div class="circle"></div>
        <div class="circle"></div>
      </div>
      <div class="text" id="storeTitle"></div>
    </div>
    <div class = "page1">
      <div class = "qrcode-container" id="qrcodePage">
        <div class="qrcode-title">ç·šä¸Šå€™ä½QR Code</div>
        <div class="qrcode-bg">
          <div id="about-qrcode"></div>
        </div>
        <div class="qrcode-title2">åˆ°è™Ÿé€šçŸ¥</div>
      </div> 
    </div>
    <div class = "page2">
    <div class="group-container" id="groupContainer">
      <!-- <div class="group-card" id="card01" onclick="selectcard(this)">
        <div class="group-title">1~2äºº</div>
        <div class="group-info">
          <span class="icon"><img src="./images/waiting_normal.png"></span>
          ç­‰å¾…çµ„æ•¸ <span class="count">11</span> çµ„
        </div>
      </div>

      <div class="group-card" id="card02" onclick="selectcard(this)">
        <div class="group-title">3~4äºº</div>
        
        <div class="group-info">
          <span class="icon"><img src="./images/waiting_normal.png"></span>
          ç­‰å¾…çµ„æ•¸ <span class="count">15</span> çµ„
        </div>
      </div>

      <div class="group-card" id="card03" onclick="selectcard(this)">
        <div class="group-title">5~6äºº</div>
        
        <div class="group-info">
          <span class="icon"><img src="./images/waiting_normal.png" ></span>
          ç­‰å¾…çµ„æ•¸ <span class="count">03</span> çµ„
        </div>
      </div>

      <div class="group-card" id="card04" onclick="selectcard(this)">
        <div class="group-title">7~8äºº</div>
        <div class="group-info">

          <span class="icon"><img src="./images/waiting_normal.png"></span>
          ç­‰å¾…çµ„æ•¸ <span class="count">00</span> çµ„
        </div>
      </div> 
      <div class="group-card" id="card05" onclick="selectcard(this)">
        <div class="group-title">9~10äºº</div>
        <div class="group-info">

          <span class="icon"><img src="./images/waiting_normal.png"></span>
          ç­‰å¾…çµ„æ•¸ <span class="count">00</span> çµ„
        </div>
      </div>        -->
    </div>
    <p class="refresh hidden">éè™Ÿè«‹é‡æ–°å–è™Ÿ</p>  
    </div>
  </div>
  <div class="right">
  <div class="arrow-label" onclick="goTakeTicketPage()" id="ticketPageButton" >ç¾å ´å–è™Ÿ</div> 
  <button class="confirm-button disabled hidden" id="btnConfirm" onclick="doTakeTicket()">ç¢ºå®š</button>
  <!-- <button class="home-button disabled hidden" id="btnhome" onclick="doGoHome()">
    <img src="./images/home.png">
  </button>     -->

  </div>
</div>
<!-- å‚™è¨» -->
<div class="footer">
  <img src="images/logo_mini.png">
  <div id="ver">ver.0.0.1</div>
</div>
<!-- æµ®å‹•è¦–çª—èˆ‡èƒŒæ™¯é®ç½© -->
<div class="overlay2" id="modalOverlay" onclick="closeModal()">
  <div class="modal">
    <div class="modal-box">
      <div class="pStore">æ‚¨çš„è™Ÿç¢¼æ˜¯</div>
      <div class="pSection" id="nowSection">5~6äºº</div>
      <div class="pNumber" id="nowTakeNumber">056</div>
      <div class="modal-box-info">
        <!-- <span class="icon">ğŸ‘¤</span> -->
        <span class="modal-box-icon"><img src="./images/waiting_normal.png"></span>
        ç­‰å¾…çµ„æ•¸ <span class="modal-box-count">00</span> çµ„
      </div>      
    </div>
    <!-- <div class = "modal-box">
        <div class="modal-button" onclick="closeModal()">é—œé–‰</div>
    </div> -->
  </div>
</div>  
<div class="overlay2" id="modalOverlay2">
  <div class="modal" style="justify-content: center;">
    <div class="modal-box">
      <p style="font-size: 2rem;">ç¾åœ¨æš«åœå–è™Ÿ</p>
    </div>
    <!-- <div class = "modal-box">
        <div class="modal-button" onclick="closeModal()">é—œé–‰</div>
    </div> -->
  </div>
</div>  
<script>
  let storename = "èª è¨˜è¶Šå—éºµé£Ÿé¤¨-æ°¸åº·ç¸½åº—";
  let callername = null;
  let selectId=null;
  let nowValue=0;
  let nowUserGetNum = 0;
  let itemGroup=null;
  let lastIsOnLineGet = true; //è¨˜éŒ„ä¸Šä¸€å€‹ç‹€æ…‹.
  let txtUsername, base64Encoded;
  let clientId = null;
  let userID=null;
  let isOnlineGet = null;
  let bClickedAddButton = false;
  let inactivityTime = 10000; // 10 ç§’
  let timer;
  let nowGetNumItem = null;
  let ws = null;
  //let reconnecting = false;
  
  let initData={
    caller_id: null,								// å«è™Ÿæ©Ÿ id
    hardware: null,									// æœ‰ç„¡å¯¦é«”å–è™Ÿæ©Ÿ (true/fasle).
    caller_name: null, 
    curr_num: null,                 // ç›®å‰è™Ÿç¢¼
    support_get_num: null,          // æ”¯æ´å–è™Ÿ (true/false)
    last_get_num: null,             // æœ€å¾Œå–è™Ÿ (è‹¥ä¸æ”¯æ´å–è™Ÿæœå‹™ï¼Œæ­¤æ¬„ç‚º"")
    get_num_switch: null,           // å–è™Ÿé–‹é—œ ("on"/"off") (è‹¥ä¸æ”¯æ´å–è™Ÿæœå‹™ï¼Œæ­¤æ¬„ç‚º"")
    get_num_item_type:null,         // å–è™Ÿé …ç›®å‹åˆ¥ (è‹¥ä¸æ”¯æ´"é¸æ“‡å–è™Ÿé …ç›®", æ­¤æ¬„ç‚º"")
    get_num_item_data: null,		    //(å–è™Ÿé …ç›®è™Ÿç¢¼è³‡æ–™)(ç”¨ä¾†å–ä»£ get_num_item_queue)
    get_num_item_names: null,     	// å–è™Ÿé …ç›®åç¨±
    get_num_item_queue: null,       // å–è™Ÿé …ç›®è™Ÿç¢¼ä½‡åˆ—
    get_num_notes: null,            // å–è™Ÿéœ€çŸ¥ (è‹¥ä¸é¡¯ç¤ºå–è™Ÿéœ€çŸ¥ï¼Œæ­¤æ¬„è¨­ç‚º"")(è‹¥ä¸æ”¯æ´å–è™Ÿæœå‹™ï¼Œæ­¤æ¬„ç‚º"")
    support_reserve_num: null,      // æ”¯æ´åˆ°è™Ÿä¿ç•™ (true/false)(è‹¥ä¸æ”¯æ´å–è™Ÿæœå‹™ï¼Œæ­¤æ¬„ç‚ºfalse)
    reserve_time_limit: null, 			//(åˆ°è™Ÿä¿ç•™æœŸé™)
    reset_time:null,								//(é‡ç½®æ™‚é–“)
    uuid: null // å°åŒ…è­˜åˆ¥ç¢¼"support_get_num"(æ”¯æ´å–è™Ÿ)
  };
  const translations = {
      EN: {
        str00:"Select Language",
        str01: "Now Serving",
        str02: "Re-take Number",
        str03: "Click to Get a Number",
        str04: "Your number:",
        str05: "Estimated Wait Time (minutes) :"
      },
      TW: {
        str00:"é¸æ“‡èªè¨€",
        str01: "ç›®å‰å«è™Ÿ",
        str02: "é‡æ–°å–è™Ÿ",
        str03: "é»æ“Šå–è™Ÿ",
        str04: "ä½ çš„è™Ÿç¢¼ï¼š",
        str05: "é è¨ˆç­‰å¾…åˆ†é˜ï¼š"
      },
      JP: {
        str00:"è¨€èªã‚’é¸æŠ",
        str01: "ç¾åœ¨å‘¼ã³å‡ºã—ä¸­",
        str02: "ç•ªå·ã‚’å–ã‚Šç›´ã™",
        str03: "ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç•ªå·ã‚’å–å¾—",
        str04: "ã‚ãªãŸã®ç•ªå·:",
        str05: "äºˆæƒ³å¾…ã¡æ™‚é–“ï¼ˆåˆ†ï¼‰:"
      },
      KR: {
        str00:"ì–¸ì–´ ì„ íƒ",
        str01: "í˜„ì¬ í˜¸ì¶œ ì¤‘",
        str02: "ë²ˆí˜¸ ë‹¤ì‹œ ë°›ê¸°",
        str03: "í´ë¦­í•˜ì—¬ ë²ˆí˜¸ ë°›ê¸°",
        str04: "ë‹¹ì‹ ì˜ ë²ˆí˜¸ :",
        str05: "ì˜ˆìƒ ëŒ€ê¸° ì‹œê°„ (ë¶„):"
      } 
    };
    // èªç³»å°æ‡‰è¡¨ï¼ˆä½ å¯ä¾éœ€æ±‚èª¿æ•´ï¼‰
    const langMap = {
        'en': 'EN',
        'zh': 'TW',
        'zh-TW': 'TW',
        'ja': 'JP',
        'ko': 'KR'
    };
  let nowpage=1;
  let urlParams = new URLSearchParams(window.location.search);
  let username = urlParams.get("username"); // è‹¥ç„¡å‰‡çµ¦é è¨­å€¼
  console.log(username);
  if(username){
      clientId = username.toLocaleLowerCase();
  }  
  userID = generateUserId();  //ç”¢ç”Ÿç©å®¶ID.

    //print-ticket å¢åŠ é€™ä¸‰è¡Œ
  let print = urlParams.get("print") || CONFIG.PRINT; // print=1 å‘¼å« local print server,print=0 ä¸åˆ—å°
  let spacing = urlParams.get("spacing") || CONFIG.SPACING; // æ¯è¡Œæ–‡å­—è·Ÿä¸‹ä¸€è¡Œä¸­çš„æ–·è¡Œè¡Œé«˜
  let paper = urlParams.get("paper") || CONFIG.PAPER; // å°è¡¨æ©Ÿç´™å¼µæ˜¯ 58mmæˆ–80mm


  const versionMeta = document.querySelector('meta[name="version"]');
  const version = versionMeta ? versionMeta.getAttribute('content') : 'æœªçŸ¥ç‰ˆæœ¬';
  document.getElementById('ver').innerText = "ver."+version;

  //todo: æš«æ™‚ç§»é™¤èªè¨€é¸æ“‡,ç›´åˆ°æä¾›èªç³»ç¿»è­¯.
  // const earthbtn = document.getElementById('earth'); //reget.
  // earthbtn.addEventListener('click', () => {
  //     //alert("åœ–ç‰‡æŒ‰éˆ•è¢«é»æ“Šäº†ï¼");
  //     // é€™è£¡å¯åŠ å…¥ä½ çš„å…¶ä»–äº‹ä»¶é‚è¼¯
  //     document.getElementById("dropdownMenu").classList.toggle("show");
  // });

  window.selectOption = (radio)=>{
      // alert("ä½ é¸æ“‡äº†ï¼š" + radio.value);
      document.getElementById('langstr').innerText = radio.value;
      document.getElementById("dropdownMenu").classList.remove("show");
      //changeLanguage(radio.value);
  };
  function setSelectOption(value){
      document.getElementById('langstr').innerText = value;
      //changeLanguage(value);
      const dropform = document.getElementById("languageSelector");
      for (let i = 0; i < dropform.length; i++) {
          if(dropform[i].value === value){
              dropform[i].checked = true;
          }
      }
  }  
  function showStorename(){
      //console.log('showStorename:'+storename);
      //document.getElementById("storeTitle").innerText = storename;
      if(callername !== null){
          document.getElementById("storeTitle").innerText = storename+' ['+callername+']';    
      }else{
          document.getElementById("storeTitle").innerText = storename;
      }      
  }
  function showNowNumber(){
      let paddedNumber = String(nowValue).padStart(3,"0");
      document.getElementById("currentCall").innerText = paddedNumber;
  }
  function showNowGetNumber(){
    //è¨ˆç®—å„çµ„ç­‰å¾…çµ„æ•¸.
    itemGroup.forEach((obj, idx)=>{
      let cnt = obj.length;
      //console.log(idx+" "+cnt);
      setWaitingNumber(idx,cnt);
    });
  }
  function setNumItemData(itemNameList,inData, blogin){
    console.log('setNumItemData');
    itemGroup = [];
    for(const idx in itemNameList){
      let subGroup=[];
      itemGroup.push(subGroup);
    }
    for (const key in inData ){
      let numItemData = inData[key];
      if(numItemData.state === "waiting"){
        //console.log(numItemData);
        sub=itemGroup[Number(numItemData.get_num_item_id)].push(Number(key));
        
      }
    }
  }

  function selectcard(card) {
    const btn = document.getElementById("btnConfirm");
    // å¦‚æœé€™å¼µå¡ç‰‡å·²ç¶“æ˜¯é¸å–ç‹€æ…‹ï¼Œå°±å–æ¶ˆé¸å–
    if (card.classList.contains('selected')) {
      card.classList.remove('selected');
      selectId = null;
      if(!btn.classList.contains('disabled')){
        btn.classList.add('disabled');
        btn.disabled = true;
      }
      return;
    }

    // å…ˆç§»é™¤å…¶ä»–å¡ç‰‡çš„é¸å–ç‹€æ…‹
    document.querySelectorAll('.group-card').forEach(c => {
      c.classList.remove('selected');
    });
    selectId = card.id;
    // å¥—ç”¨ç•¶å‰å¡ç‰‡çš„é¸å–ç‹€æ…‹
    card.classList.add('selected');
    if(btn.classList.contains('disabled')){
        btn.classList.remove('disabled');
        btn.disabled = false;
    }
    resetTimer();
  }

  function goTakeTicketPage(){
    initPage2();
  }
  function doTakeTicket(){
    //é€å‡ºå–è™Ÿå°åŒ….
    //openModal();
    let btn = document.getElementById("btnConfirm");
    if(!btn.classList.contains('disabled')){
      btn.classList.add('disabled');
      btn.disabled = true;

    }
    console.log(selectId)
    let id = Number(selectId.replace("card",""))-1;
    bClickedAddButton = true;
    sendGetNum(clientId, id);
    //todo: 
    resetTimer();
  }
  function openModal(getnum, itemid){
      document.getElementById('modalOverlay').style.display = 'flex';
      document.getElementById('nowSection').textContent = initData.get_num_item_names[Number(itemid)];
      document.getElementById('nowTakeNumber').textContent = getnum;
      let count = document.getElementById('modalOverlay').querySelector('.modal-box-count');
      let cnt = itemGroup[Number(itemid)].length;
      if(count){
        count.textContent = cnt;
      }

      // document.getElementById('nowTakeNumber').textContent = itemobj.num;
      // const now = new Date();
      // document.getElementById("nowTimestamp").innerText = now.toLocaleString('zh-TW', {
      //     year: 'numeric', month: 'long', day: 'numeric',
      //     hour: 'numeric', minute: 'numeric', second: 'numeric',
      //     hour12: false
      // });
      //document.getElementById('nowTimestamp').textContent = new Date();
  }
  function removeCardSelect(){
    // å…ˆç§»é™¤å…¶ä»–å¡ç‰‡çš„é¸å–ç‹€æ…‹
    document.querySelectorAll('.group-card').forEach(c => {
      c.classList.remove('selected');
    });
    selectId = null;
    const btn = document.getElementById("btnConfirm");
    if(!btn.classList.contains('disabled')){
      btn.classList.add('disabled');
      btn.disabled = true;
    }  
  }
  function closeModal2(){
    
    document.getElementById('modalOverlay2').style.display = 'none';
  }
  function openModal2(){
    document.getElementById('modalOverlay2').style.display = 'flex';
  }
  function closeModal(){
    document.getElementById('modalOverlay').style.display = 'none';
    removeCardSelect();
    }
  function clearSection(){
    const groupContainer = document.getElementById("groupContainer");
    groupContainer.innerHTML = ""; // æ¸…ç©ºèˆŠçš„å…§å®¹
  }
  function addSection(groups){
    const groupContainer = document.getElementById("groupContainer");
    groups.forEach((title, index) => {
      const card = document.createElement("div");
      card.className = "group-card";
      card.id = `card${String(index + 1).padStart(2, "0")}`;
      card.onclick = () => selectcard(card);

      // æ¨™é¡Œ
      const groupTitle = document.createElement("div");
      groupTitle.className = "group-title";
      groupTitle.textContent = title;

      // è³‡è¨Š
      const groupInfo = document.createElement("div");
      groupInfo.className = "group-info";

      const icon = document.createElement("span");
      icon.className = "icon";
      const img = document.createElement("img");
      img.src = "./images/waiting_normal.png";
      icon.appendChild(img);

      const text = document.createTextNode("ç­‰å¾…çµ„æ•¸ ");
      const count = document.createElement("span");
      count.className = "count";
      count.textContent = "00"; // é è¨­ 00 çµ„
      const unit = document.createTextNode(" çµ„");

      groupInfo.appendChild(icon);
      groupInfo.appendChild(text);
      groupInfo.appendChild(count);
      groupInfo.appendChild(unit);

      card.appendChild(groupTitle);
      card.appendChild(groupInfo);

      groupContainer.appendChild(card);
    });
  }
    function setWaitingNumber(groupIdx, count){
      let cardId = `card${String(groupIdx + 1).padStart(2, "0")}`;
      let  c=document.getElementById(cardId); 
      if(c){
        const countSpan = c.querySelector('.count');
        if (countSpan) {
          countSpan.textContent = String(count).padStart(2, "0");
        }
      }
    }
    function drawOnlineGet(mode){
      if(isOnlineGet=== true){
        initData.get_num_switch = 'on';
        closeModal2();
      }else{
        initData.get_num_switch = 'off';
        openModal2();
      }
    }
    function resetData(){
      itemGroup=[];
      itemGroup = [];
      for(const idx in initData.get_num_item_names){
        let subGroup=[];
        itemGroup.push(subGroup);
        setWaitingNumber(idx, 0);
      }        
    }

  //generateQRCode();
    function generateQRCode(){
      const qrcodecontainer = document.getElementById("about-qrcode");
      if(!qrcodecontainer){
        return;
      }
    //   console.log(`æ–°çš„å¯¬åº¦: ${window.innerWidth}px`);
    //   console.log(`æ–°çš„é«˜åº¦: ${window.innerHeight}px`);

      let rateX = Math.floor(window.innerWidth*0.18);
      let rateY =  Math.floor(window.innerHeight*0.18);

      let qWidth = 200;
      if(rateX > rateY){
        if(rateY > qWidth){
            if(rateY > 400){
                qWidth = 400;
            }else{
                qWidth = rateY;
            }
        }
      }else{
        if(rateX > qWidth){
            if(rateX > 180){
                qWidth = 180;
            }else{
                qWidth = rateX;
            }
        }
      }
    
        qrcodecontainer.innerHTML = "";

        var qrcode = new QRCode(document.getElementById("about-qrcode"), {
            width: qWidth,
            height: qWidth,
        });
        // var url = "https://line.me/R/oaMessage/@callmeback/?";
        let url = "https://liff.line.me/2003918297-NKaR4P9w/?shop_name=";
        let nurl = url+encodeURI(storename);
        // é€²è¡Œ URL ç·¨ç¢¼ï¼ˆä¸­æ–‡ç­‰ç‰¹æ®Šå­—å…ƒæœƒè¢«è½‰ç‚ºç™¾åˆ†æ¯”ç·¨ç¢¼ï¼‰
        if(callername!== null){
            nurl=url+encodeURI(storename)+"&caller_name="+encodeURI(callername);
        }        
        // é€²è¡Œ URL ç·¨ç¢¼ï¼ˆä¸­æ–‡ç­‰ç‰¹æ®Šå­—å…ƒæœƒè¢«è½‰ç‚ºç™¾åˆ†æ¯”ç·¨ç¢¼ï¼‰
        qrcode.makeCode(nurl);
        //document.getElementById("about-qrcode").

    }

  window.addEventListener("load",()=>{
    generateQRCode();
  });
  // åœ¨ç¶²é åŠ è¼‰å®Œæˆå¾Œè‡ªå‹•å‘¼å« connectWebSocket
  window.onload = function () {
      const userLang = navigator.language || navigator.userLanguage; // e.g., "zh-TW"
      const shortLang = userLang.split('-')[0]; // e.g., "zh"
      
      // å„ªå…ˆä½¿ç”¨å®Œæ•´èªè¨€ç¢¼ï¼ˆä¾‹å¦‚ zh-TWï¼‰ï¼Œå…¶æ¬¡ç”¨ç°¡å¯«ï¼ˆzhï¼‰
      const selectedValue = langMap[userLang] || langMap[shortLang];
      if(!selectedValue){
          selectedValue = 'EN';
      }
      if (selectedValue) {
          console.log(selectedValue);
          setSelectOption(selectedValue); // è‹¥ä½ éœ€è¦åŒæ­¥åŸ·è¡Œè‡ªå®šå‡½å¼
      }
      initPage1();
      ws = createWebSocket();
  };
      //-----------------------------------------------------------------------
    let wsSendLogin = (txtUsername, txtPasswordHash) => {
      if (!ws) {
          return;
      }
      if (!ws) return;
      //const msg = `${username},AUTH,${password}`;
      const msg = `{"action": "login","vendor_id": "tawe","caller_id": "${txtUsername}","password":"${txtPasswordHash}","uuid": ""}`;  
      ws.send(msg);
    };

    function sendGetNum(callerId, itemID) {
      const msg = {
        action: "user_get_num",
        vendor_id: "tawe",
        caller_id: callerId,
        user_id: userID,
        get_num_item_id: itemID.toString(),
        for_customer:true,
        uuid: ""
      };
      ws.send(JSON.stringify(msg));
      console.log(`ç™¼é€ user_get_num è«‹æ±‚`);
    }

    // function tryReconnect() {
    //   if (reconnecting) {
    //     console.log("[WS] Reconnect skipped (already trying)");
    //     return;
    //   }
    //   reconnecting = true;
    //   ws.reconnecting();
    //   // setTimeout(() => {
    //   //   console.log("[WS] Reconnecting...");
    //   //   createWebSocket(clientId, label);
    //   // }, 3000); // 3 ç§’å¾Œé‡è©¦
    // }
    
    let createWebSocket = () => {
        console.log(`[WS] createWebSocket called,  existing?`, ws);

        if (ws && ws.readyState !== WebSocket.CLOSED) {
          console.warn("[WS] Skip create, connection still alive");
          return ws;
        }
        if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
          console.log("å·²æœ‰ WebSocket é€£ç·šï¼Œä¸å†é‡å»º");
          return ws;
        }        

        //ws = new WebSocket('wss://cmb-caller-frontend-410240967190.asia-east1.run.app/');		//Live.
        ws = new window.MyWebSocketLow('wss://cmb-caller-frontend-410240967190.asia-east1.run.app/');		//Live.
		    //ws = new window.MyWebSocketLow('wss://cmb-caller-frontend-306511771181.asia-east1.run.app/');     //Trial.
        ws.id = clientId;
        // ws.onmessage = (data) => {
        ws.onmessage = (data) => {
          
          //console.log('[WebSocket æ”¶åˆ°å›å‚³è³‡æ–™]', data);

				  let len = data.length;
				  if(len > 1){
            const cmd = data[data.length - 1];
            if (cmd && cmd.toLowerCase() === 'auth') {
                const state = data[0];
                if (state === 'OK') {
                    console.log('é©—è­‰é€šé');
                    agentName = data[1];
                } else {
                    const errorCode = data[1];
                    if (errorCode === '001' || errorCode === '002') {
                        console.log('é©—è­‰å¤±æ•—');
                    }
                }
            }
          }else{
            //json.
            if(data.action ==="login"){
              if(data.result==="OK"){
                console.log('é©—è­‰é€šé');
                // å«è™Ÿæ©Ÿåç¨±
                if(data.caller_name!== undefined){
                  agentName = data.caller_name;
                  initData.caller_name = data.caller_name;
                  storename=agentName;
                  if(agentName.indexOf(';;') !== -1){
                    let str2=agentName.split(';;');
                    storename = str2[0];
                    callername = str2[1];
                  }                     
                  showStorename();
                }
                // ç›®å‰è™Ÿç¢¼
                if(data.curr_num!== undefined){
                  nowValue = data.curr_num;
                  initData.curr_num = data.curr_num;
                  showNowNumber();
                }
                // æ”¯æ´å–è™Ÿ (true/false)
                if(data.support_get_num!== undefined){
                  initData.support_get_num = data.support_get_num;
                }
                // æœ€å¾Œå–è™Ÿ (è‹¥ä¸æ”¯æ´å–è™Ÿæœå‹™ï¼Œæ­¤æ¬„ç‚º"")
                if(data.last_get_num!== undefined){
                  initData.last_get_num = data.last_get_num;
                }
                // å–è™Ÿé–‹é—œ ("on"/"off") (è‹¥ä¸æ”¯æ´å–è™Ÿæœå‹™ï¼Œæ­¤æ¬„ç‚º"")
                if(data.get_num_switch!== undefined){
                  initData.get_num_switch = data.get_num_switch;
                  if(data.get_num_switch === 'on'){
                      isOnlineGet = true;
                  }else if(data.get_num_switch === 'off'){
                      isOnlineGet = false;
                  }                  
                  drawOnlineGet();
                }
                // å–è™Ÿé …ç›®å‹åˆ¥ (è‹¥ä¸æ”¯æ´"é¸æ“‡å–è™Ÿé …ç›®", æ­¤æ¬„ç‚º"")
                if(data.get_num_item_type!== undefined){
                  initData.get_num_item_type = data.get_num_item_type;
                }
                // å–è™Ÿé …ç›®åç¨±
                if(data.get_num_item_names!== undefined){
                  initData.get_num_item_names = data.get_num_item_names;
                  if(initData.get_num_item_names !== ""){
                    clearSection();
                    addSection(initData.get_num_item_names);
                  }
                }
                // (å–è™Ÿé …ç›®è™Ÿç¢¼è³‡æ–™)
                if(data.get_num_item_data!== undefined){
                  initData.get_num_item_data = data.get_num_item_data;
                  setNumItemData(initData.get_num_item_names, initData.get_num_item_data ,true);
                  showNowGetNumber();
                }	                
                // å–è™Ÿé …ç›®è™Ÿç¢¼ä½‡åˆ—
                if(data.get_num_item_queue!== undefined){
                  initData.get_num_item_queue = data.get_num_item_queue;
                }
                // å–è™Ÿéœ€çŸ¥ (è‹¥ä¸é¡¯ç¤ºå–è™Ÿéœ€çŸ¥ï¼Œæ­¤æ¬„è¨­ç‚º"")(è‹¥ä¸æ”¯æ´å–è™Ÿæœå‹™ï¼Œæ­¤æ¬„ç‚º"")
                if(data.get_num_notes!== undefined){
                    initData.get_num_notes = data.get_num_notes;
                    // showNotices(initData.get_num_notes);
                }
                // æ”¯æ´åˆ°è™Ÿä¿ç•™ (true/false)(è‹¥ä¸æ”¯æ´å–è™Ÿæœå‹™ï¼Œæ­¤æ¬„ç‚ºfalse)							
                if(data.support_reserve_num!== undefined){
                    initData.support_reserve_num = data.support_reserve_num;
                }	
                //(åˆ°è™Ÿä¿ç•™æœŸé™)	
                if(data.reserve_time_limit!== undefined){
                    initData.reserve_time_limit = data.reserve_time_limit;
                }	
                //(é‡ç½®æ™‚é–“)			
                if(data.reset_time!== undefined){
                    initData.reset_time = data.reset_time;
                    // if(nowUserGetNumTime){
                    //     let bReset = checkTimeOut(nowUserGetNumTime);
                    //     console.log(bReset);
                    //     if(bReset === true){
                    //         console.log('breset=true å°‡reItemGroupæ­¸é›¶,ä¸”å„²å­˜æ¸…é›¶');
                    //         clearGetNumTime();
                    //         clearData();
                    //         nowUserGetNumTime=null;
                    //         nowUserGetNumValue = null;
                    //         nowWaitTimeValue = null;
                    //         lockUserGetNum = false;
                    //         screenInit();                        
                    //     }
                    // }
                }		
                // å°åŒ…è­˜åˆ¥ç¢¼"support_get_num"(æ”¯æ´å–è™Ÿ)
                if(data.uuid!== undefined){
                  initData.uuid = data.uuid;
                }
              } else {
                const errorCode = data[1];
                if (errorCode === '001' || errorCode === '002') {
                  console.log('é©—è­‰å¤±æ•—');
                }
              }
            }	            
          }
        };
        ws.onopen = async () => {
            //console.log('[WebSocket é–‹å•ŸæˆåŠŸ]');
            
            const txtPassword = '88888888';
            console.log(`WebSocket é–‹å•Ÿ`);
          // 1. è¨ˆç®— SHA-256 é›œæ¹Šå€¼
            const sha256Hash = CryptoJS.SHA256(txtPassword);
            // 2. å°‡é›œæ¹Šå€¼è½‰æ›ç‚º Base64 ç·¨ç¢¼
            base64Encoded = sha256Hash.toString(CryptoJS.enc.Base64);
            txtUsername = clientId;
            
            wsSendLogin(txtUsername, base64Encoded);            
        };
        ws.onclose = () => {
            //console.warn('[WebSocket å·²é—œé–‰]');
            //console.log("[WS] CLOSE", e.code, e.reason);
            //if (!reconnecting) tryReconnect();
            setTimeout(() => {
              console.log("[WS] Reconnecting...");
              ws.reconnecting();
            }, 2000); // 2 ç§’å¾Œé‡è©¦
            
        };
        ws.onerror = (err) => {
            console.error('[WebSocket éŒ¯èª¤]', err);
        };
        ws.addEventListener('message', (data) => {
            console.log('[WebSocket æ”¶åˆ°å›å‚³è³‡æ–™]', data);

            let len = data.length;
            //console.log(data);

            //if(len > 1){
            if(len > 1 && data[0]==="OK"){            
                let cmd = data[len-1];
                if(data[0]==="OK" && data[1] ===clientId)
                {
                    if(cmd === 'send' && len === 4){
                        console.log('send'+data);
                    }else if(cmd === 'get'&& len === 4){
                        nowValue = data[2];
                        showNowNumber();
                        showNowGetNumber();
                        
                    }else if(cmd === 'update'&& len === 4){ 
                        nowValue = data[2];
                        showNowNumber(data[2]);

                        if((initData)&&(initData.get_num_item_type !== "")){
                            if(Number(nowValue) === 0){
                                //serveré€reset.
                                resetData();
                            }else{
                              if(initData.get_num_item_data) {
                                let obj2=  initData.get_num_item_data[data[2]];
                                if(obj2){
                                  obj2.called_time = new Date().getTime();
                                  obj2.state = "called";
                                }
                                let section = obj2.get_num_item_id;

                                let pidx = itemGroup[Number(section)].indexOf(Number(data[2]));
                                if(pidx!== -1){
                                  itemGroup[Number(section)].splice(pidx,1); 
                                }
                                showNowGetNumber();
                              } 
                            }
                        }else{
                            // if(Number(nowValue)<= Number(nowUserGetNum)){
                            //     let less = Number(nowUserGetNum)-Number(nowValue);
                            //     nowLessValue = less.toString();
                            // }else{
                            //     nowLessValue = 0;
                            // }
                            showNowGetNumber();
                        }
                        
                    }else if(cmd === 'get_num_info' && len ===5){
                        nowUserGetNum = data[2];
                        if(Number(nowValue)<= Number(nowUserGetNum)){
                            let less = Number(nowUserGetNum)-Number(nowValue);
                            nowLessValue = less.toString();
                        }else{
                            nowLessValue = 0;
                        }
                        showNowGetNumber();
                    }    
                }
            }else if(data[0]!=="Fail"){
                //jsonæ ¼å¼.
                //console.log(data);
                let obj = data;
                if((obj.result === 'OK') && (obj.caller_id === clientId)){
                    if(obj.action === 'get_num_status'){
                        if(obj.switch === 'on'){
                            isOnlineGet = true;
                        }else if(obj.switch === 'off'){
                            isOnlineGet = false;
                        }
                        lastIsOnLineGet = isOnlineGet;
                        drawOnlineGet(true);
                    }else if(obj.action === 'get_num_switch'){
                        if(obj.switch === 'on'){
                            isOnlineGet = true;
                        }else if(obj.switch === 'off'){
                            isOnlineGet = false;
                        }
                        lastIsOnLineGet = isOnlineGet;
                        drawOnlineGet(true);                    
                    }else if(obj.action  === 'user_get_num'){
                        console.log('webå–è™Ÿ.');
                        if(obj.get_num){
                          nowUserGetNum = obj.get_num;
                        }
                        if(initData.get_num_item_data) {
                          let obj2= {
                            called_time:"",
                            for_customer: obj.for_customer || false,
                            get_from_web: obj.get_from_web || false,
                            get_num_item_id: obj.get_num_item_id,
                            state: "waiting"
                          };
                          initData.get_num_item_data[obj.get_num] = obj2;

                          if(itemGroup[Number(obj.get_num_item_id)].indexOf(obj.get_num) === -1){
                             itemGroup[Number(obj.get_num_item_id)].push(obj.get_num); 
                          }
                          showNowGetNumber();
                          // if(bClickedAddButton === true){
                          //     openModal(obj.get_num, obj.get_num_item_id);
                          // }
                          if(bClickedAddButton === true){
                            removeCardSelect();
                            bClickedAddButton = false; 
                          }
                          if(obj.get_num_item_id){
                            nowGetNumItem =  initData.get_num_item_names[Number(obj.get_num_item_id)];
                            console.log(nowGetNumItem);
                          }
                          if(obj.user_id === userID) {
                            //æœ¬æ©Ÿå–è™Ÿ.  
                            //print-ticket å¢åŠ 
                            if (print === "1") {
                                printTicket(storename,callername,nowGetNumItem,nowUserGetNum,spacing,paper);    
                            }                              
                          }
                        } 
                    }else if(obj.action === 'get_num_info'){
                        console.log('get_num_info');
                        if(obj.curr_num){
                          nowValue = data.curr_num;
                          initData.curr_num = data.curr_num;
                          showNowNumber();
                        }
                        if(obj.get_num_item_type !== ""){
                          if(obj.get_num_item_names!==""){
                            initData.get_num_item_names = obj.get_num_item_names;
                            let cnt = initData.get_num_item_names.length;
                            if(cnt === 1){
                                bfullScreen = true;
                            }     
                            clearSection();                       
                            addSection(initData.get_num_item_names);
                          }
                          if(obj.get_num_item_data !==""){
                            initData.get_num_item_data = [];
                            initData.get_num_item_data = obj.get_num_item_data;
                            setNumItemData(initData.get_num_item_names, initData.get_num_item_data ,false);
                            showNowGetNumber();
                          }
                        }
                    }else if(obj.action === 'web_cancel_get_num'){
                        console.log(obj);
                        //å–æ¶ˆå–è™Ÿ(webä½¿ç”¨è€…).
                        if(obj.cancel_num){
                            //ç§»é™¤æ¶ˆå–è™Ÿ.remove.
                            let objdata = initData.get_num_item_data[obj.cancel_num.toString()];
                            if(objdata!==undefined){
                              initData.get_num_item_data[obj.cancel_num.toString()].state = "removed";
                              let sectionid = initData.get_num_item_data[obj.cancel_num.toString()].get_num_item_id;
                              let cidx = itemGroup[Number(sectionid)].indexOf(obj.cancel_num);
                              if(cidx !== -1){
                                itemGroup[Number(sectionid)].splice(cidx,1);  //ç§»é™¤å–æ¶ˆè™Ÿ.
                              }
                              showNowGetNumber();
                            }
                        }  
                    }else if(obj.action === 'remove_number'){
                        console.log(obj);
                        //ç§»é™¤è™Ÿç¢¼.
                        if(obj.remove_num){
                            //ç§»é™¤æ¶ˆå–è™Ÿ.remove.
                          let objdata = initData.get_num_item_data[obj.remove_num.toString()];
                          if(objdata!==undefined){
                            initData.get_num_item_data[obj.remove_num.toString()].state = "removed";
                            let sectionid = initData.get_num_item_data[obj.remove_num.toString()].get_num_item_id;
                            let cidx = itemGroup[Number(sectionid)].indexOf(obj.remove_num);
                            if(cidx !== -1){
                              itemGroup[Number(sectionid)].splice(cidx,1);  //ç§»é™¤å–æ¶ˆè™Ÿ.
                            }
                            showNowGetNumber();   
                          }               
                        }
                    }
                }else if((obj.caller_id === clientId) && (obj.action  === 'new_get_num')){
                    console.log('new_get_num 2 WEB å–è™Ÿ');
                    if((obj.curr_num) && (obj.curr_num !== "")){
                        nowUserGetNum = obj.curr_num;
                    }else{
                        //result fail.
                        return;
                    }
                    if(initData.get_num_item_data) {
                      let obj2= {
                        called_time:"",
                        for_customer: obj.for_customer || false,
                        get_from_web: obj.get_from_web || false,
                        get_num_item_id: obj.get_num_item_id,
                        state: "waiting"
                      };
                      initData.get_num_item_data[obj.get_num] = obj2;

                      if(itemGroup[Number(obj.get_num_item_id)].indexOf(obj.get_num) === -1){
                          itemGroup[Number(obj.get_num_item_id)].push(obj.get_num); 
                      }
                      showNowGetNumber();
                    } 
                }else if((obj.caller_id === clientId)&&(obj.action === 'cancel_get_num')){
                    console.log(obj);
                    //å–æ¶ˆå–è™Ÿ(Lineä½¿ç”¨è€…).
                    if(obj.cancel_num){
                        //ç§»é™¤æ¶ˆå–è™Ÿ.remove.
                        let objdata = initData.get_num_item_data[obj.cancel_num.toString()];
                        if(objdata!==undefined){
                          initData.get_num_item_data[obj.cancel_num.toString()].state = "removed";
                          let sectionid = initData.get_num_item_data[obj.cancel_num.toString()].get_num_item_id;
                          let cidx = itemGroup[Number(sectionid)].indexOf(obj.cancel_num);
                          if(cidx !== -1){
                            itemGroup[Number(sectionid)].splice(cidx,1);  //ç§»é™¤å–æ¶ˆè™Ÿ.
                          }
                          showNowGetNumber();
                        }
                    }    
                }else if((obj.caller_id === clientId)&& (obj.action === 'reserve_number')){
                    //åˆ°è™Ÿä¿ç•™ï¼š(ä¸­å¤®ä¸»å‹•å‚³é€)
                    //if(obj.reserve === true){
                        //è½‰æˆä¿ç•™è‰²è™Ÿ.
                    //    reserveNumItem(Number(obj.number));
                    console.log('åˆ°è™Ÿä¿ç•™ï¼š(ä¸­å¤®ä¸»å‹•å‚³é€) '+obj.reserve);
                    if(obj.reserve === false){
                        //ç§»é™¤ä¿ç•™.remove.
                        /*unreserveNumItem(Number(obj.number));*/
                    }     
                    
                }else if((obj.result) && (obj.result!=="OK")){
                    //Failåˆ¤æ–·.
                    console.log(obj.result);
                    let errCode = obj.result.split(/[,:]/);
                    if(errCode[0] ==='Fail'){
                        let codeNum = errCode[1].trim();
                        console.log(errCode[1]);
                        if(lastIsOnLineGet!==isOnlineGet){
                            isOnlineGet = lastIsOnLineGet;
                            drawOnlineGet(true);  
                        }
                    }
                    bClickedAddButton = false;
                }
            }else if(data[0]==="Fail"){
                let cmd = data[len-1];
                let errorNum = data[1].substr(0, 3);
                //console.log('cmd:'+cmd+' data[1]:'+data[1]+ ' errorNum:'+errorNum);
                if((cmd === 'get_num_info') && (errorNum==='007')){
                    hideGetNumberInfo();
                }
                if(lastIsOnLineGet!==isOnlineGet){
                    console.log(data[1]);
                    isOnlineGet = lastIsOnLineGet;
                    drawOnlineGet(true);  
                }
                bClickedAddButton = false;
            }
        });

        return ws;
    };

    //-----------------------------------------------------------------------
    
	function generateUserId() {
      // ç”¢ç”Ÿä¸€çµ„éš¨æ©Ÿå­—ä¸²ï¼ˆUUID v4 ç°¡åŒ–ç‰ˆï¼‰
      const userid = 'xxxxxxxxyxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        return r.toString(16);
      });
      
	  return userid.toUpperCase();
      //document.getElementById('userId').textContent = `ä½¿ç”¨è€… ID: ${userId}`;
  }
  function initPage1(){
    nowpage = 1;
    document.querySelectorAll('.page2').forEach(c => {
      if(!c.classList.contains('hidden')){
        c.classList.add('hidden');
      }
    });

    const groupcards = document.getElementById("groupContainer");
    const btn = document.getElementById("btnConfirm");
    if(!groupcards.classList.contains('hidden')){
      groupcards.classList.add('hidden');
    }
    if(!btn.classList.contains('hidden')){
      btn.classList.add('hidden');
    }
    if(!btn.classList.contains('disabled')){
      btn.classList.add('disabled');
      btn.disabled = true;
    }

    document.querySelectorAll('.refresh').forEach(c => {
      if(!c.classList.contains('hidden')){
        c.classList.add('hidden');
      }
    });
    // const btnhome = document.getElementById("btnhome");
    // if(!btnhome.classList.contains('hidden')){
    //   btnhome.classList.add('hidden');
    // }
    // if(!btnhome.classList.contains('disabled')){
    //   btnhome.classList.add('disabled');
    //   btnhome.disabled = true;
    // }
    document.querySelectorAll('.page1').forEach(c => {
      if(c.classList.contains('hidden')){
        c.classList.remove('hidden');
      }
    });

    const qrcodepage = document.getElementById("qrcodePage");
    const btn1 = document.getElementById("ticketPageButton");
    if(qrcodePage.classList.contains('hidden')){
      qrcodePage.classList.remove("hidden");
    }
    if(btn1.classList.contains('hidden')){
      btn1.classList.remove("hidden");
    }
    if(btn1.classList.contains('disabled')){
      btn1.classList.remove("disabled");
      btn1.disabled = false;
    }    
  }
  // function doGoHome(){
  //   initPage1();
  // }
  function initPage2(){
    nowpage = 2;
    document.querySelectorAll('.page1').forEach(c => {
      if(!c.classList.contains('hidden')){
        c.classList.add('hidden');
      }
    });    
    const qrcodepage = document.getElementById("qrcodePage");
    const btn1 = document.getElementById("ticketPageButton");
    if(!qrcodePage.classList.contains('hidden')){
      qrcodePage.classList.add("hidden");
    }
    if(!btn1.classList.contains('hidden')){
      btn1.classList.add("hidden");
    }
    if(!btn1.classList.contains('disabled')){
      btn1.classList.add("disabled");
      btn1.disabled = true;
    }

    document.querySelectorAll('.page2').forEach(c => {
      if(c.classList.contains('hidden')){
        c.classList.remove('hidden');
      }
    });
    const groupcards = document.getElementById("groupContainer");
    const btn = document.getElementById("btnConfirm");
    if(groupcards.classList.contains('hidden')){
      groupcards.classList.remove('hidden');
    }
    if(btn.classList.contains('hidden')){
      btn.classList.remove('hidden');
    }    
    removeCardSelect();
    document.querySelectorAll('.refresh').forEach(c => {
      if(c.classList.contains('hidden')){
        c.classList.remove('hidden');
      }
    });
    // const btnhome = document.getElementById("btnhome");
    // if(btnhome.classList.contains('hidden')){
    //   btnhome.classList.remove('hidden');
    // }
    // if(btnhome.classList.contains('disabled')){
    //   btnhome.classList.remove('disabled');
    //   btnhome.disabled = false;
    // }
    resetTimer();
  }

  function resetTimer() {
    if(timer){
      clearTimeout(timer);
    }
    
    timer = setTimeout(() => {
      //window.location.href = "otherpage.html"; // é€™è£¡æ›æˆä½ è¦è·³è½‰çš„ç¶²å€
      if(nowpage === 2){
        clearTimeout(timer);
        initPage1();
      }
    }, inactivityTime);
  }


  //ç¶²è·¯æª¢æŸ¥.
  window.addEventListener("offline", () => {
    console.log("ç¶²è·¯æ–·ç·š");
    if (ws) ws.close();
  });

  window.addEventListener("online", () => {
    console.log("ç¶²è·¯æ¢å¾©ï¼Œå˜—è©¦é‡é€£");
    //createWebSocket("ws://example.com");
  });

  document.addEventListener("visibilitychange", () => {
    if (!document.hidden && (!ws || ws.readyState !== WebSocket.OPEN)) {
      console.log("é é¢å›åˆ°å‰æ™¯ï¼Œæª¢æŸ¥é€£ç·š");
      //createWebSocket("ws://example.com");
    }
  });

</script>    
</body>
</html>
